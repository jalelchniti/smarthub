<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Database Purge - SmartHub</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
        }
        h1 { text-align: center; color: #fff; }
        h2 { color: #ffd700; border-bottom: 2px solid #ffd700; padding-bottom: 10px; }
        .warning { 
            background: rgba(239, 68, 68, 0.3); 
            border: 3px solid #ef4444; 
            padding: 20px; 
            border-radius: 15px;
            margin: 20px 0;
            font-weight: bold;
            font-size: 18px;
        }
        .status { 
            padding: 15px; 
            border-radius: 10px; 
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: rgba(34, 197, 94, 0.2); border: 2px solid #22c55e; }
        .status.error { background: rgba(239, 68, 68, 0.2); border: 2px solid #ef4444; }
        .status.info { background: rgba(59, 130, 246, 0.2); border: 2px solid #3b82f6; }
        button {
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: transform 0.2s;
            font-weight: bold;
        }
        button:hover { transform: scale(1.05); }
        .button-group { text-align: center; margin: 20px 0; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .btn-success { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .btn-disabled { background: #6b7280; cursor: not-allowed; opacity: 0.5; }
        pre { 
            background: rgba(0,0,0,0.3); 
            padding: 15px; 
            border-radius: 8px; 
            overflow-x: auto; 
            font-size: 12px;
        }
        .countdown {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            color: #ffd700;
            margin: 20px 0;
        }
        .confirmation-step {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #f59e0b;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            display: none;
        }
        .confirmation-step.active { display: block; }
        input[type="text"] {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #ffd700;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            width: 300px;
        }
        input[type="text"]::placeholder { color: rgba(255, 255, 255, 0.7); }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number { font-size: 1.5em; font-weight: bold; color: #ffd700; }
    </style>
</head>
<body>
    <h1>ğŸ—‘ï¸ Firebase Database Purge Utility</h1>
    <p style="text-align: center;">âš ï¸ DANGER ZONE - Complete Database Cleanup âš ï¸</p>

    <div class="container">
        <div class="warning">
            ğŸš¨ <strong>CRITICAL WARNING</strong> ğŸš¨<br><br>
            This utility will <strong>PERMANENTLY DELETE ALL BOOKING DATA</strong> from the Firebase database.<br><br>
            âš¡ This action is <strong>IRREVERSIBLE</strong><br>
            ğŸ’¾ No backups will be created<br>
            ğŸ”¥ All booking entries will be lost forever<br><br>
            <strong>Use this only for development/testing purposes!</strong>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š Current Database Status</h2>
        <div id="connectionStatus" class="status info">Checking connection...</div>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalBookings">-</div>
                <div>Total Bookings</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingBookings">-</div>
                <div>Pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="paidBookings">-</div>
                <div>Paid</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cancelledBookings">-</div>
                <div>Cancelled</div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-primary" onclick="checkDatabase()">ğŸ” Check Database Status</button>
            <button class="btn-success" onclick="exportBackup()">ğŸ“¥ Export Backup</button>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ—‘ï¸ Database Purge Process</h2>
        <p>Follow the steps below to safely purge all booking data:</p>

        <!-- Step 1: Initial Check -->
        <div class="confirmation-step active" id="step1">
            <h3>Step 1: Database Analysis</h3>
            <p>First, let's check what data exists in the database:</p>
            <button class="btn-primary" onclick="analyzeDatabase()">ğŸ” Analyze Current Data</button>
            <div id="analysisResult"></div>
        </div>

        <!-- Step 2: Confirmation -->
        <div class="confirmation-step" id="step2">
            <h3>Step 2: Confirmation Required</h3>
            <p>Type <strong>"DELETE ALL BOOKINGS"</strong> to confirm you want to purge the database:</p>
            <input type="text" id="confirmationText" placeholder="Type: DELETE ALL BOOKINGS" style="width: 100%; max-width: 400px;">
            <br><br>
            <button class="btn-danger btn-disabled" id="confirmButton" onclick="confirmPurge()" disabled>
                âš ï¸ I Understand - Proceed to Purge
            </button>
        </div>

        <!-- Step 3: Final Warning -->
        <div class="confirmation-step" id="step3">
            <h3>Step 3: Final Warning</h3>
            <div class="warning">
                ğŸš¨ LAST CHANCE TO CANCEL ğŸš¨<br><br>
                You are about to permanently delete <span id="bookingCount">X</span> booking(s).<br><br>
                <strong>This cannot be undone!</strong>
            </div>
            <div class="countdown" id="countdown">5</div>
            <button class="btn-danger btn-disabled" id="finalButton" disabled onclick="executePurge()">
                ğŸ’€ DELETE ALL DATA NOW
            </button>
            <button class="btn-primary" onclick="cancelPurge()">âŒ Cancel - Keep Data Safe</button>
        </div>

        <!-- Step 4: Progress -->
        <div class="confirmation-step" id="step4">
            <h3>Step 4: Purging Database</h3>
            <div id="purgeProgress" class="status info">Initializing purge process...</div>
            <div id="purgeDetails"></div>
        </div>

        <!-- Step 5: Complete -->
        <div class="confirmation-step" id="step5">
            <h3>âœ… Purge Complete</h3>
            <div id="purgeResult" class="status success">Database purged successfully!</div>
            <div class="button-group">
                <button class="btn-success" onclick="verifyPurge()">ğŸ” Verify Empty Database</button>
                <button class="btn-primary" onclick="resetUtility()">ğŸ”„ Reset Utility</button>
                <button class="btn-primary" onclick="window.location.href='check-firebase-db.html'">ğŸ“Š Open Database Monitor</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ”§ Backup Data (Optional)</h2>
        <p>Before purging, you can export current data as a backup:</p>
        <pre id="backupData" style="display: none; max-height: 300px; overflow-y: scroll;"></pre>
        <div class="button-group">
            <button class="btn-primary" onclick="showBackupData()">ğŸ“„ Show Raw Data</button>
            <button class="btn-success" onclick="downloadBackup()" id="downloadBtn" style="display: none;">ğŸ’¾ Download Backup JSON</button>
        </div>
    </div>

    <!-- Firebase CDN Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBnjZRrhG7qmJqcZcJWO7FnN2LznNSk07k",
            authDomain: "u-smart-booking.firebaseapp.com",
            databaseURL: "https://u-smart-booking-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "u-smart-booking",
            storageBucket: "u-smart-booking.firebasestorage.app",
            messagingSenderId: "512917348858",
            appId: "1:512917348858:web:77d83cc427db118f118443"
        };

        // Initialize Firebase
        let database;
        let currentData = null;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            updateConnectionStatus('âœ… Firebase connected successfully', 'success');
            checkDatabase();
        } catch (error) {
            updateConnectionStatus('âŒ Firebase connection failed: ' + error.message, 'error');
            console.error('Firebase init error:', error);
        }

        function updateConnectionStatus(message, type) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }

        function updateStats(data) {
            const bookings = data?.bookings || {};
            const bookingsArray = Object.values(bookings);
            
            const stats = {
                total: bookingsArray.length,
                pending: bookingsArray.filter(b => (b.paymentStatus || 'pending') === 'pending').length,
                paid: bookingsArray.filter(b => b.paymentStatus === 'paid').length,
                cancelled: bookingsArray.filter(b => b.paymentStatus === 'cancelled').length
            };

            document.getElementById('totalBookings').textContent = stats.total;
            document.getElementById('pendingBookings').textContent = stats.pending;
            document.getElementById('paidBookings').textContent = stats.paid;
            document.getElementById('cancelledBookings').textContent = stats.cancelled;

            return stats;
        }

        async function checkDatabase() {
            updateConnectionStatus('ğŸ” Checking database...', 'info');
            
            try {
                const ref = database.ref('/');
                const snapshot = await ref.once('value');
                
                if (snapshot.exists()) {
                    currentData = snapshot.val();
                    updateConnectionStatus('âœ… Database loaded successfully', 'success');
                    const stats = updateStats(currentData);
                } else {
                    updateConnectionStatus('ğŸ“­ Database is empty', 'info');
                    updateStats({});
                }
            } catch (error) {
                updateConnectionStatus('âŒ Failed to check database: ' + error.message, 'error');
                console.error('Database check error:', error);
            }
        }

        async function analyzeDatabase() {
            await checkDatabase();
            
            const result = document.getElementById('analysisResult');
            
            if (!currentData || !currentData.bookings || Object.keys(currentData.bookings).length === 0) {
                result.innerHTML = `
                    <div class="status info">
                        ğŸ“­ <strong>Database is empty or contains no bookings.</strong><br>
                        Nothing to purge!
                    </div>
                `;
                return;
            }

            const bookings = Object.values(currentData.bookings);
            const stats = updateStats(currentData);
            
            result.innerHTML = `
                <div class="status info">
                    <strong>ğŸ“Š Database Analysis Results:</strong><br><br>
                    ğŸ”¢ Total bookings found: <strong>${stats.total}</strong><br>
                    â³ Pending: ${stats.pending}<br>
                    âœ… Paid: ${stats.paid}<br>
                    âŒ Cancelled: ${stats.cancelled}<br><br>
                    ğŸ“… Date range: ${getDateRange(bookings)}<br>
                    ğŸ¢ Rooms used: ${getRoomsUsed(bookings)}<br><br>
                    <strong style="color: #ef4444;">All of this data will be permanently deleted!</strong>
                </div>
            `;

            // Enable next step
            showStep('step2');
            setupConfirmationInput();
        }

        function getDateRange(bookings) {
            if (bookings.length === 0) return 'None';
            const dates = bookings.map(b => b.date).sort();
            return `${dates[0]} to ${dates[dates.length - 1]}`;
        }

        function getRoomsUsed(bookings) {
            if (bookings.length === 0) return 'None';
            const rooms = [...new Set(bookings.map(b => `Salle ${b.roomId}`))];
            return rooms.join(', ');
        }

        function setupConfirmationInput() {
            const input = document.getElementById('confirmationText');
            const button = document.getElementById('confirmButton');
            
            input.addEventListener('input', (e) => {
                if (e.target.value.trim() === 'DELETE ALL BOOKINGS') {
                    button.disabled = false;
                    button.className = 'btn-danger';
                } else {
                    button.disabled = true;
                    button.className = 'btn-danger btn-disabled';
                }
            });
        }

        function confirmPurge() {
            const input = document.getElementById('confirmationText');
            if (input.value.trim() !== 'DELETE ALL BOOKINGS') {
                alert('Please type exactly: DELETE ALL BOOKINGS');
                return;
            }

            // Update booking count for final warning
            const stats = updateStats(currentData);
            document.getElementById('bookingCount').textContent = stats.total;

            showStep('step3');
            startCountdown();
        }

        function startCountdown() {
            let count = 5;
            const countdownEl = document.getElementById('countdown');
            const finalButton = document.getElementById('finalButton');
            
            const timer = setInterval(() => {
                count--;
                countdownEl.textContent = count;
                
                if (count <= 0) {
                    clearInterval(timer);
                    countdownEl.textContent = 'âš ï¸';
                    finalButton.disabled = false;
                    finalButton.className = 'btn-danger';
                }
            }, 1000);
        }

        async function executePurge() {
            showStep('step4');
            
            const progressEl = document.getElementById('purgeProgress');
            const detailsEl = document.getElementById('purgeDetails');
            
            try {
                // Step 1: Clear all bookings
                progressEl.textContent = 'ğŸ—‘ï¸ Clearing all bookings...';
                progressEl.className = 'status info';
                
                await database.ref('bookings').set({});
                
                detailsEl.innerHTML = '<div class="status success">âœ… All bookings cleared</div>';
                
                // Step 2: Reset structure with default data
                progressEl.textContent = 'ğŸ”§ Resetting database structure...';
                
                const defaultData = {
                    rooms: {
                        "1": { name: "Salle 1", capacity: 15 },
                        "2": { name: "Salle 2", capacity: 9 },
                        "3": { name: "Salle 3", capacity: 9 }
                    },
                    bookings: {},
                    timeSlots: {
                        weekdays: [
                            "08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30",
                            "12:00", "12:30", "15:00", "15:30", "16:00", "16:30", "17:00", "17:30", 
                            "18:00", "18:30", "19:00", "19:30"
                        ],
                        sunday: [
                            "08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30",
                            "12:00", "12:30"
                        ]
                    },
                    weekDays: ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"],
                    startDate: "2025-09-15",
                    lastUpdated: new Date().toISOString()
                };
                
                await database.ref('/').set(defaultData);
                
                detailsEl.innerHTML += '<div class="status success">âœ… Database structure reset to defaults</div>';
                
                // Step 3: Complete
                progressEl.textContent = 'âœ… Purge completed successfully!';
                progressEl.className = 'status success';
                
                detailsEl.innerHTML += `
                    <div class="status success">
                        ğŸ‰ <strong>Database Purge Complete!</strong><br><br>
                        âœ… All booking entries removed<br>
                        âœ… Database structure reset to defaults<br>
                        âœ… System ready for fresh bookings<br><br>
                        <strong>Purge completed at:</strong> ${new Date().toLocaleString('fr-FR')}
                    </div>
                `;

                setTimeout(() => {
                    showStep('step5');
                }, 2000);

            } catch (error) {
                progressEl.textContent = 'âŒ Purge failed!';
                progressEl.className = 'status error';
                detailsEl.innerHTML += `<div class="status error">âŒ Error: ${error.message}</div>`;
                console.error('Purge error:', error);
            }
        }

        function cancelPurge() {
            if (confirm('Are you sure you want to cancel the purge operation?')) {
                resetUtility();
            }
        }

        function resetUtility() {
            // Hide all steps except the first one
            document.querySelectorAll('.confirmation-step').forEach(step => step.classList.remove('active'));
            document.getElementById('step1').classList.add('active');
            
            // Reset input
            document.getElementById('confirmationText').value = '';
            
            // Refresh database status
            checkDatabase();
        }

        async function verifyPurge() {
            await checkDatabase();
            
            if (!currentData || !currentData.bookings || Object.keys(currentData.bookings).length === 0) {
                alert('âœ… Verification successful! Database is completely empty.');
            } else {
                alert('âš ï¸ Warning: Database still contains booking data. Purge may have been incomplete.');
            }
        }

        function showStep(stepId) {
            document.querySelectorAll('.confirmation-step').forEach(step => step.classList.remove('active'));
            document.getElementById(stepId).classList.add('active');
        }

        async function showBackupData() {
            await checkDatabase();
            const backupEl = document.getElementById('backupData');
            const downloadBtn = document.getElementById('downloadBtn');
            
            if (currentData) {
                backupEl.textContent = JSON.stringify(currentData, null, 2);
                backupEl.style.display = 'block';
                downloadBtn.style.display = 'inline-block';
            } else {
                backupEl.textContent = 'No data to backup - database is empty.';
                backupEl.style.display = 'block';
                downloadBtn.style.display = 'none';
            }
        }

        function downloadBackup() {
            if (!currentData) {
                alert('No data available for backup.');
                return;
            }

            const dataStr = JSON.stringify(currentData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `smarthub-firebase-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        async function exportBackup() {
            await checkDatabase();
            if (currentData && currentData.bookings && Object.keys(currentData.bookings).length > 0) {
                downloadBackup();
            } else {
                alert('No bookings found to backup.');
            }
        }

        // Auto-initialize
        window.addEventListener('load', () => {
            setTimeout(checkDatabase, 500);
        });
    </script>
</body>
</html>